#!/bin/bash

# Author: Giacomo Iadarola

SCRIPTPATH="$( cd "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"

function validate_url(){
  if [[ $(wget -S --spider "$1" 2>&1 | grep 'HTTP/1.1 200 OK') ]]; then
    echo "true"
  fi
}

# Check if virtualenv installed
if ! command -v virtualenv &> /dev/null
then
    echo "'virtualenv' not found, proceed with installation? [y/N]"
    # shellcheck disable=SC2162
    read -n 2 RES
    if [ "$RES" == "y" ]; then
        echo "Installing python3-virtualenv..."
        sudo apt install python3-virtualenv
    else
        echo ""
        echo "OK, proceeding without virtualenv..."
    fi
else
  echo "Create the virtual environment 'venv' with python3 in "
  virtualenv "${SCRIPTPATH}/venv" -p /usr/bin/python3

  # Activate the virtual environment
  # shellcheck disable=SC1090
  source "${SCRIPTPATH}"/venv/bin/activate
fi

${SCRIPTPATH}/venv/bin/pip install -r ${SCRIPTPATH}/requirements.txt

echo "Setting main_path to tami in utils.config"
# tells git to ignore changes in config.py
# can be reversed with 'git update-index --no-skip-worktree <file-list>'
git update-index --skip-worktree "${SCRIPTPATH}"/utils/config.py

# Using '@' insted of '/' as delimiter for sed, to avoid confusion
STANDARD_VAR_MAIN="main_path = \"/<INSERT_FULL_PATH_TO_REPO_FOLDER>/tami/\""
NEW_VAR_MAIN="main_path = \"${SCRIPTPATH}/\""
sed -i "s@${STANDARD_VAR_MAIN}@${NEW_VAR_MAIN}@g" "${SCRIPTPATH}"/utils/config.py

echo "Setup complete!"



